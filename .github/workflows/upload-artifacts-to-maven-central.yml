name: Upload artifacts to Maven Central

env:
  ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.SONATYPE_TOKEN_USER }}
  ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.SONATYPE_TOKEN_USER_PASSWORD }}
  ORG_GRADLE_PROJECT_signingInMemoryKeyId: ${{ secrets.MAVEN_ANDROID_SIGNING_KEY }}
  ORG_GRADLE_PROJECT_signingInMemoryKey: ${{ secrets.MAVEN_ANDROID_GPG_KEY }}
  ORG_GRADLE_PROJECT_signingInMemoryKeyPassword: ${{ secrets.MAVEN_ANDROID_SIGNING_PASSWORD }}

on:
  workflow_call:
    inputs:
      rc_version:
        required: true
        type: string
  workflow_dispatch:
    inputs:
      rc_version:
        description: 'Version to create new RC for. Specify <major.minor.patch>, e.g. 7.1.2'
        required: true

permissions:
  contents: write

jobs:
  release:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    steps:
      - name: Checkout scripts
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # 6.0.2
        with:
          sparse-checkout: .github/scripts
          persist-credentials: false

      - name: Configure git
        run: .github/scripts/configure-git.sh

      - name: Extract base version (major.minor.0)
        id: base_version
        env:
          RC_VERSION: ${{ inputs.rc_version }}
        run: .github/scripts/extract-base-version.sh "$RC_VERSION" >> $GITHUB_OUTPUT

      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # 6.0.2
        with:
          ref: release/${{ steps.base_version.outputs.base_version }}
          persist-credentials: true

      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: 'adopt'
          java-version: 21

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@f29f5a9d7b09a7c6b29859002d29d24e1674c884 # v5.0.1

      - name: Publish to Maven Central
        run: .github/scripts/gradle-publish-maven-central.sh

      - name: Publish git tag
        env:
          RC_VERSION: ${{ inputs.rc_version }}
        run: .github/scripts/publish-git-tag.sh "$RC_VERSION"
